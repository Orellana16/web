<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head(${title})}"></head>
<body>
    <div th:replace="~{layout/base :: navbar}"></div>
    <div th:replace="~{layout/base :: messages}"></div>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- ========== PANEL DE FILTROS (COLUMNA IZQUIERDA) ========== -->
            <div class="col-lg-3">
                <div class="filtros-container">
                    <div class="filtros-panel">
                        <h5><i class="bi bi-funnel-fill"></i> Filtros de Búsqueda</h5>
                        
                        <form th:action="@{/propiedades}" method="get" id="formFiltros">
                            <input type="hidden" name="sortBy" th:value="${sortBy}">
                            <input type="hidden" name="sortDir" th:value="${sortDir}">
                            
                            <!-- Tipo de Propiedad -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-boxes"></i> Tipo de Propiedad</label>
                                <div th:each="tipoDisp : ${tiposDisponibles}" class="form-check">
                                    <input class="form-check-input" type="checkbox" name="tipo" th:value="${tipoDisp}" th:id="'tipo_' + ${tipoDisp}" th:checked="${filtro_tipo.contains(tipoDisp)}">
                                    <label class="form-check-label" th:for="'tipo_' + ${tipoDisp}" th:text="${tipoDisp}"></label>
                                </div>
                            </div>
                            
                            <!-- Derrama -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-currency-euro"></i> Derrama Mensual</label>
                                <div class="row g-2">
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="derramaMin" th:value="${filtro_derramaMin}" placeholder="Mín."></div>
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="derramaMax" th:value="${filtro_derramaMax}" placeholder="Máx."></div>
                                </div>
                            </div>
                            
                            <!-- Dirección del Inmueble -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-geo-alt-fill"></i> Dirección Inmueble</label>
                                <input type="text" class="form-control form-control-sm" name="direccionInmueble" th:value="${filtro_direccionInmueble}" placeholder="Buscar...">
                            </div>
                            
                            <!-- Inmueble Específico -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-house-door-fill"></i> Inmueble</label>
                                <select class="form-select form-select-sm" name="inmuebleId">
                                    <option value="">Todos</option>
                                    <option th:each="inm : ${inmueblesDisponibles}" th:value="${inm.id}" th:text="${inm.id + ' - ' + inm.direccion}" th:selected="${filtro_inmuebleId != null && filtro_inmuebleId == inm.id}"></option>
                                </select>
                            </div>
                            
                            <!-- Botones -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-success"><i class="bi bi-search"></i> Aplicar Filtros</button>
                                <a th:href="@{/propiedades}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Limpiar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- ========== LISTADO (COLUMNA DERECHA) ========== -->
            <div class="col-lg-9">
                <div class="lista-container">
                    <div class="card">
                        <div class="card-header bg-success d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 text-white">
                                <i class="bi bi-boxes"></i> Propiedades Adicionales
                                <span class="badge bg-light text-dark ms-2" th:text="${totalItems}">0</span>
                            </h4>
                            <a th:href="@{/propiedades/new}" class="btn btn-light"><i class="bi bi-plus-circle-fill"></i> Nueva</a>
                        </div>
                        <div class="card-body">
                            
                            <!-- Filtros activos -->
                            <div th:if="${!filtro_tipo.isEmpty() or filtro_derramaMin != null or filtro_direccionInmueble != null}" class="mb-3">
                                <small class="text-muted d-block mb-2"><i class="bi bi-funnel"></i> Filtros activos:</small>
                                <span th:each="tipo : ${filtro_tipo}" class="filter-badge success"><i class="bi bi-boxes"></i> <span th:text="${tipo}"></span></span>
                                <span th:if="${filtro_derramaMin != null}" class="filter-badge success">Derrama Mín: <span th:text="${filtro_derramaMin}"></span>€</span>
                                <span th:if="${filtro_derramaMax != null}" class="filter-badge success">Derrama Máx: <span th:text="${filtro_derramaMax}"></span>€</span>
                                <span th:if="${filtro_direccionInmueble != null}" class="filter-badge success"><i class="bi bi-geo-alt"></i> <span th:text="${filtro_direccionInmueble}"></span></span>
                            </div>
                            
                            <div th:if="${!propiedades.isEmpty()}" class="table-responsive">
                                <table class="table table-hover table-striped">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'id\')'">ID <i class="bi sort-icon" th:classappend="${sortBy == 'id'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'tipo\')'">Tipo <i class="bi sort-icon" th:classappend="${sortBy == 'tipo'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th>Inmueble</th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'derrama\')'">Derrama <i class="bi sort-icon" th:classappend="${sortBy == 'derrama'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th>IBI</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="prop : ${propiedades}">
                                            <td th:text="${prop.id}"></td>
                                            <td>
                                                <i class="bi bi-car-front text-primary" th:if="${prop.tipo == 'Garaje'}"></i>
                                                <i class="bi bi-box text-warning" th:if="${prop.tipo == 'Trastero'}"></i>
                                                <i class="bi bi-water text-info" th:if="${prop.tipo == 'Piscina'}"></i>
                                                <span th:text="${prop.tipo}"></span>
                                            </td>
                                            <td><a th:href="@{/inmuebles/{id}(id=${prop.inmueble.id})}" th:text="${prop.inmueble.direccion}"></a></td>
                                            <td th:text="${prop.derrama} + ' €'"></td>
                                            <td th:text="${prop.ibi}"></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:href="@{/propiedades/{id}(id=${prop.id})}" class="btn btn-info" title="Ver"><i class="bi bi-eye"></i></a>
                                                    <a th:href="@{/propiedades/{id}/edit(id=${prop.id})}" class="btn btn-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                                                    <button type="button" class="btn btn-danger" th:onclick="'confirmarEliminar(' + ${prop.id} + ')'" title="Eliminar"><i class="bi bi-trash"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div th:if="${propiedades.isEmpty()}" class="alert alert-info text-center">No hay propiedades que cumplan los criterios.</div>
                            
                            <!-- PAGINACIÓN -->
                            <nav th:if="${totalPages > 1}" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${currentPage - 1} + '); return false;'">Anterior</a></li>
                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${i} + '); return false;'" th:text="${i + 1}"></a></li>
                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${currentPage + 1} + '); return false;'">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{layout/base :: scripts}"></div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        
        function cambiarPagina(page) {
            params.set('page', page);
            window.location.href = currentUrl.pathname + '?' + params.toString();
        }
        
        function ordenarPor(campo) {
            const sortBy = /*[[${sortBy}]]*/ 'id';
            const sortDir = /*[[${sortDir}]]*/ 'asc';
            params.set('sortBy', campo);
            params.set('sortDir', sortBy === campo && sortDir === 'asc' ? 'desc' : 'asc');
            params.set('page', '0');
            window.location.href = currentUrl.pathname + '?' + params.toString();
        }
        
        function confirmarEliminar(id) {
            if (confirm('¿Está seguro de que desea eliminar esta propiedad adicional?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/propiedades/' + id + '/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }
        /*]]>*/
    </script>
</body>
</html>