<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/base :: head(${title})}"></head>
<body>
    <div th:replace="~{layout/base :: navbar}"></div>
    <div th:replace="~{layout/base :: messages}"></div>

    <div class="container-fluid px-4">
        <div class="row">
            <!-- ========== PANEL DE FILTROS (COLUMNA IZQUIERDA) ========== -->
            <div class="col-lg-3">
                <div class="filtros-container">
                    <div class="filtros-panel">
                        <h5><i class="bi bi-funnel-fill"></i> Filtros de Búsqueda</h5>
                        
                        <form th:action="@{/inmuebles}" method="get" id="formFiltros">
                            <input type="hidden" name="sortBy" th:value="${sortBy}">
                            <input type="hidden" name="sortDir" th:value="${sortDir}">
                            
                            <!-- Dirección -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-geo-alt-fill"></i> Dirección</label>
                                <input type="text" class="form-control form-control-sm" name="direccion" th:value="${filtro_direccion}" placeholder="Buscar por dirección...">
                            </div>
                            
                            <!-- Tipo de Vivienda -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-house-fill"></i> Tipo de Vivienda</label>
                                <div th:each="tipo : ${tiposVivienda}" class="form-check">
                                    <input class="form-check-input" type="checkbox" name="tipoVivienda" th:value="${tipo}" th:id="'tipo_' + ${tipo}" th:checked="${filtro_tipoVivienda.contains(tipo)}">
                                    <label class="form-check-label" th:for="'tipo_' + ${tipo}" th:text="${tipo}"></label>
                                </div>
                            </div>
                            
                            <!-- Tipo de Operación -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-tag-fill"></i> Operación</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="tipoOperacion" value="0" id="opVenta" th:checked="${filtro_tipoOperacion.contains(0)}">
                                    <label class="form-check-label" for="opVenta">Venta</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="tipoOperacion" value="1" id="opAlquiler" th:checked="${filtro_tipoOperacion.contains(1)}">
                                    <label class="form-check-label" for="opAlquiler">Alquiler</label>
                                </div>
                            </div>
                            
                            <!-- Precio -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-currency-euro"></i> Precio</label>
                                <div class="row g-2">
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="precioMin" th:value="${filtro_precioMin}" placeholder="Mín."></div>
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="precioMax" th:value="${filtro_precioMax}" placeholder="Máx."></div>
                                </div>
                            </div>
                            
                            <!-- Habitaciones -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-door-open-fill"></i> Habitaciones</label>
                                <div class="row g-2">
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="numHabMin" th:value="${filtro_numHabMin}" placeholder="Mín."></div>
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="numHabMax" th:value="${filtro_numHabMax}" placeholder="Máx."></div>
                                </div>
                            </div>
                            
                            <!-- Metros -->
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-rulers"></i> Metros²</label>
                                <div class="row g-2">
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="metrosMin" th:value="${filtro_metrosMin}" placeholder="Mín."></div>
                                    <div class="col-6"><input type="number" class="form-control form-control-sm" name="metrosMax" th:value="${filtro_metrosMax}" placeholder="Máx."></div>
                                </div>
                            </div>
                            
                            <!-- Botones -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Aplicar Filtros</button>
                                <a th:href="@{/inmuebles}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Limpiar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- ========== LISTADO (COLUMNA DERECHA) ========== -->
            <div class="col-lg-9">
                <div class="lista-container">
                    <div class="card">
                        <div class="card-header bg-primary d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 text-white">
                                <i class="bi bi-house-door-fill"></i> Inmuebles
                                <span class="badge bg-light text-dark ms-2" th:text="${totalItems}">0</span>
                            </h4>
                            <a th:href="@{/inmuebles/new}" class="btn btn-light"><i class="bi bi-plus-circle-fill"></i> Nuevo</a>
                        </div>
                        <div class="card-body">
                            
                            <!-- Filtros activos -->
                            <div th:if="${filtro_direccion != null or !filtro_tipoVivienda.isEmpty() or filtro_precioMin != null}" class="mb-3">
                                <small class="text-muted d-block mb-2"><i class="bi bi-funnel"></i> Filtros activos:</small>
                                <span th:if="${filtro_direccion != null}" class="filter-badge"><i class="bi bi-geo-alt"></i> <span th:text="${filtro_direccion}"></span></span>
                                <span th:each="tipo : ${filtro_tipoVivienda}" class="filter-badge"><i class="bi bi-house"></i> <span th:text="${tipo}"></span></span>
                                <span th:if="${filtro_precioMin != null}" class="filter-badge">Desde <span th:text="${#numbers.formatDecimal(filtro_precioMin, 0, 'COMMA', 0, 'POINT')}"></span>€</span>
                                <span th:if="${filtro_precioMax != null}" class="filter-badge">Hasta <span th:text="${#numbers.formatDecimal(filtro_precioMax, 0, 'COMMA', 0, 'POINT')}"></span>€</span>
                            </div>
                            
                            <div th:if="${!inmuebles.isEmpty()}" class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'id\')'">ID <i class="bi sort-icon" th:classappend="${sortBy == 'id'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'direccion\')'">Dirección <i class="bi sort-icon" th:classappend="${sortBy == 'direccion'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'tipoVivienda\')'">Tipo <i class="bi sort-icon" th:classappend="${sortBy == 'tipoVivienda'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th>Operación</th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'precio\')'">Precio <i class="bi sort-icon" th:classappend="${sortBy == 'precio'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'numHab\')'">Hab. <i class="bi sort-icon" th:classappend="${sortBy == 'numHab'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th class="sortable-header" th:onclick="'ordenarPor(\'metrosCuadrados\')'">m² <i class="bi sort-icon" th:classappend="${sortBy == 'metrosCuadrados'} ? (${sortDir == 'asc'} ? 'bi-sort-up' : 'bi-sort-down') : 'bi-arrow-down-up'"></i></th>
                                            <th>Props.</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="inmueble : ${inmuebles}">
                                            <td th:text="${inmueble.id}"></td>
                                            <td th:text="${inmueble.direccion}"></td>
                                            <td th:text="${inmueble.tipoVivienda}"></td>
                                            <td><span th:if="${inmueble.tipoOperacion == 0}" class="badge bg-success">Venta</span><span th:if="${inmueble.tipoOperacion == 1}" class="badge bg-info text-dark">Alquiler</span></td>
                                            <td th:text="${#numbers.formatDecimal(inmueble.precio, 0, 'COMMA', 2, 'POINT')} + ' €'"></td>
                                            <td th:text="${inmueble.numHab}"></td>
                                            <td th:text="${inmueble.metrosCuadrados} + ' m²'"></td>
                                            
                                            <!-- ⭐ AQUÍ ESTÁ LA CORRECCIÓN: Se usa la propiedad del DTO -->
                                            <td class="text-center"><span class="badge bg-secondary" th:text="${inmueble.cantidadPropiedadesAdicionales}"></span></td>
                                            
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a th:href="@{/inmuebles/{id}(id=${inmueble.id})}" class="btn btn-info" title="Ver"><i class="bi bi-eye"></i></a>
                                                    <a th:href="@{/inmuebles/{id}/edit(id=${inmueble.id})}" class="btn btn-warning" title="Editar"><i class="bi bi-pencil"></i></a>
                                                    <button type="button" class="btn btn-danger" th:onclick="'confirmarEliminar(' + ${inmueble.id} + ')'" title="Eliminar"><i class="bi bi-trash"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div th:if="${inmuebles.isEmpty()}" class="alert alert-info text-center">No hay inmuebles que cumplan los criterios.</div>
                            
                            <!-- PAGINACIÓN -->
                            <nav th:if="${totalPages > 1}" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${currentPage - 1} + '); return false;'">Anterior</a></li>
                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${i} + '); return false;'" th:text="${i + 1}"></a></li>
                                    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'"><a class="page-link" href="#" th:onclick="'cambiarPagina(' + ${currentPage + 1} + '); return false;'">Siguiente</a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{layout/base :: scripts}"></div>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        
        function cambiarPagina(page) {
            params.set('page', page);
            window.location.href = currentUrl.pathname + '?' + params.toString();
        }
        
        function ordenarPor(campo) {
            const sortBy = /*[[${sortBy}]]*/ 'id';
            const sortDir = /*[[${sortDir}]]*/ 'asc';
            params.set('sortBy', campo);
            params.set('sortDir', sortBy === campo && sortDir === 'asc' ? 'desc' : 'asc');
            params.set('page', '0');
            window.location.href = currentUrl.pathname + '?' + params.toString();
        }
        
        function confirmarEliminar(id) {
            if (confirm('¿Está seguro de que desea eliminar este inmueble?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/inmuebles/' + id + '/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }
        /*]]>*/
    </script>
</body>
</html>