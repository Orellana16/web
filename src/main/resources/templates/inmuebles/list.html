<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" data-theme="jerezsur">

<head th:replace="~{layout/base :: head(${title} ?: 'Lista de Inmuebles')}"></head>

<body class="bg-base-200 min-h-screen font-sans">

    <div th:replace="~{layout/base :: navbar('inmuebles')}"></div>
    <div th:replace="~{layout/base :: messages}"></div>

    <main class="container mx-auto px-4 py-6">
        <div class="flex flex-col lg:flex-row gap-8">

            <aside class="w-full lg:w-1/4">
                <div class="card bg-base-100 shadow-xl sticky top-6 border border-base-300/50">
                    <div class="card-body p-6">
                        <h2 class="card-title text-primary mb-4 flex items-center gap-2">
                            <i class="bi bi-funnel-fill"></i> Filtros
                        </h2>

                        <form th:action="@{/inmuebles}" method="get" id="formFiltros" class="space-y-4">
                            <input type="hidden" name="sortBy" th:value="${sortBy}">
                            <input type="hidden" name="sortDir" th:value="${sortDir}">

                            <div class="form-control w-full">
                                <label class="label pt-0"><span
                                        class="label-text font-bold text-xs uppercase opacity-70">Dirección</span></label>
                                <div class="join w-full">
                                    <span class="join-item btn btn-sm bg-base-200 border-base-300"><i
                                            class="bi bi-geo-alt"></i></span>
                                    <input type="text" name="direccion" th:value="${filtro_direccion}"
                                        placeholder="Ej: Calle Real..."
                                        class="input input-bordered input-sm join-item w-full" />
                                </div>
                            </div>

                            <div class="form-control">
                                <label class="label"><span
                                        class="label-text font-bold text-xs uppercase opacity-70">Tipo de
                                        Vivienda</span></label>
                                <div
                                    class="flex flex-col gap-1 max-h-40 overflow-y-auto pr-2 custom-scrollbar bg-base-200/30 p-2 rounded-lg">
                                    <label th:each="tipo : ${tiposVivienda}"
                                        class="label cursor-pointer justify-start gap-3 py-1 hover:bg-base-200 rounded transition-colors">
                                        <input type="checkbox" name="tipoVivienda" th:value="${tipo}"
                                            class="checkbox checkbox-primary checkbox-xs"
                                            th:checked="${filtro_tipoVivienda != null && filtro_tipoVivienda.contains(tipo)}" />
                                        <span class="label-text text-sm" th:text="${tipo}"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-control">
                                <label class="label"><span
                                        class="label-text font-bold text-xs uppercase opacity-70">Operación</span></label>
                                <div class="flex flex-row gap-4 bg-base-200/30 p-2 rounded-lg justify-around">
                                    <label class="label cursor-pointer gap-2">
                                        <input type="checkbox" name="tipoOperacion" value="0"
                                            class="checkbox checkbox-primary checkbox-sm"
                                            th:checked="${filtro_tipoOperacion != null && filtro_tipoOperacion.contains(0)}" />
                                        <span class="label-text text-xs font-semibold">Venta</span>
                                    </label>
                                    <label class="label cursor-pointer gap-2">
                                        <input type="checkbox" name="tipoOperacion" value="1"
                                            class="checkbox checkbox-secondary checkbox-sm"
                                            th:checked="${filtro_tipoOperacion != null && filtro_tipoOperacion.contains(1)}" />
                                        <span class="label-text text-xs font-semibold">Alquiler</span>
                                    </label>
                                </div>
                            </div>

                            <div class="space-y-4 pt-4 border-t border-base-300">
                                <div class="form-control">
                                    <label class="label py-1"><span
                                            class="label-text font-bold text-xs uppercase opacity-70">Precio
                                            (€)</span></label>
                                    <div class="join w-full">
                                        <input type="number" name="precioMin" th:value="${filtro_precioMin}"
                                            placeholder="Mín" class="input input-bordered input-sm join-item w-1/2" />
                                        <input type="number" name="precioMax" th:value="${filtro_precioMax}"
                                            placeholder="Máx" class="input input-bordered input-sm join-item w-1/2" />
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label py-1"><span
                                            class="label-text font-bold text-xs uppercase opacity-70">Habitaciones</span></label>
                                    <div class="join w-full">
                                        <input type="number" name="numHabMin" th:value="${filtro_numHabMin}"
                                            placeholder="Mín" class="input input-bordered input-sm join-item w-1/2" />
                                        <input type="number" name="numHabMax" th:value="${filtro_numHabMax}"
                                            placeholder="Máx" class="input input-bordered input-sm join-item w-1/2" />
                                    </div>
                                </div>
                            </div>

                            <div class="card-actions flex-col mt-6">
                                <button type="submit" class="btn btn-primary btn-block shadow-md">
                                    <i class="bi bi-search"></i> Aplicar Filtros
                                </button>
                                <a th:href="@{/inmuebles}" class="btn btn-ghost btn-block btn-sm text-error">
                                    Limpiar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </aside>

            <section class="w-full lg:w-3/4">
                <div class="card bg-base-100 shadow-xl overflow-hidden border-none rounded-xl">
                    <div class="bg-primary p-5 flex justify-between items-center text-white">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <i class="bi bi-house-door-fill"></i> Listado de Inmuebles
                            <span class="badge bg-white/20 border-none text-white px-3" th:text="${totalItems}">0</span>
                        </h2>
                        <a th:href="@{/inmuebles/new}"
                            class="btn btn-sm btn-secondary border-none text-white hover:scale-105 transition-transform">
                            <i class="bi bi-plus-lg"></i> NUEVO INMUEBLE
                        </a>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table w-full border-separate border-spacing-0">
                            <thead class="bg-base-200 text-primary uppercase text-[11px] tracking-widest font-bold">
                                <tr>
                                    <th class="py-4 px-6 border-b border-base-300">ID</th>
                                    <th class="py-4 px-6 border-b border-base-300">Dirección</th>
                                    <th class="py-4 px-6 border-b border-base-300">Operación</th>
                                    <th class="py-4 px-6 border-b border-base-300">Precio</th>
                                    <th class="py-4 px-6 border-b border-base-300 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm">
                                <tr th:each="inmueble : ${inmuebles}"
                                    class="hover:bg-base-200/50 transition-colors group">
                                    <td th:text="${inmueble.id}" class="font-bold opacity-30 px-6"></td>
                                    <td class="px-6">
                                        <div class="font-bold text-base-content" th:text="${inmueble.direccion}"></div>
                                        <div class="text-[11px] opacity-50 uppercase font-semibold"
                                            th:text="${inmueble.tipoVivienda}"></div>
                                    </td>
                                    <td class="px-6">
                                        <span th:if="${inmueble.tipoOperacion == 0}"
                                            class="badge badge-primary badge-outline font-bold text-[10px]">VENTA</span>
                                        <span th:if="${inmueble.tipoOperacion == 1}"
                                            class="badge badge-secondary font-bold text-[10px] text-white">ALQUILER</span>
                                    </td>
                                    <td class="px-6 font-bold text-primary text-md">
                                        <span
                                            th:text="${#numbers.formatDecimal(inmueble.precio, 0, 'POINT', 0, 'COMMA')}"></span>
                                        €
                                    </td>
                                    <td class="px-6 text-center">
                                        <div
                                            class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <a th:href="@{/inmuebles/{id}(id=${inmueble.id})}"
                                                class="btn btn-square btn-ghost btn-xs text-info" title="Ver detalle"><i
                                                    class="bi bi-eye-fill"></i></a>
                                            <a th:href="@{/inmuebles/{id}/edit(id=${inmueble.id})}"
                                                class="btn btn-square btn-ghost btn-xs text-accent" title="Editar"><i
                                                    class="bi bi-pencil-square"></i></a>
                                            <button class="btn btn-square btn-ghost btn-xs text-error"
                                                th:onclick="'confirmarEliminar(' + ${inmueble.id} + ')'"
                                                title="Eliminar"><i class="bi bi-trash3-fill"></i></button>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(inmuebles)}">
                                    <td colspan="5" class="text-center py-20 opacity-50 italic">No se han encontrado
                                        inmuebles con estos filtros.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div th:replace="~{layout/base :: scripts}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        function confirmarEliminar(id) {
            if (confirm('¿Está seguro de que desea eliminar este inmueble de forma permanente?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/inmuebles/' + id + '/delete';
                document.body.appendChild(form);
                form.submit();
            }
        }
        /*]]>*/
    </script>
</body>

</html>