<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{layout/base :: head(${title})}"></head>

<body>
    <div th:replace="~{layout/base :: navbar}"></div>
    <div th:replace="~{layout/base :: messages}"></div>

    <div class="container">
        <!-- Botón volver -->
        <a th:href="@{/inmuebles}" class="btn btn-secondary mb-3">
            <i class="bi bi-arrow-left"></i> Volver
        </a>

        <!-- Datos del Inmueble -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-house-door"></i> Detalle del Inmueble
                </h4>
                <div>
                    <a th:href="@{/inmuebles/{id}/edit(id=${inmueble.id})}" class="btn btn-warning btn-sm">
                        <i class="bi bi-pencil"></i> Editar
                    </a>
                    <form th:action="@{/inmuebles/{id}/delete(id=${inmueble.id})}" method="post" style="display:inline;"
                        onsubmit="return confirmarEliminacion('¿Eliminar este inmueble?');">
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> <span th:text="${inmueble.id}">1</span></p>
                        <p><strong>Dirección:</strong> <span th:text="${inmueble.direccion}">Calle</span></p>
                        <p><strong>Tipo:</strong> <span th:text="${inmueble.tipoVivienda}">Piso</span></p>
                        <p>
                            <strong>Operación:</strong>
                            <span th:if="${inmueble.tipoOperacion == 0}" class="badge bg-success">Venta</span>
                            <span th:if="${inmueble.tipoOperacion == 1}" class="badge bg-info">Alquiler</span>
                        </p>
                        <p><strong>Precio:</strong> <span th:text="${inmueble.precio} + ' €'">€</span></p>
                        <p><strong>Estado:</strong> <span th:text="${inmueble.estado}">Estado</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Habitaciones:</strong> <span th:text="${inmueble.numHab}">3</span></p>
                        <p><strong>Baños:</strong> <span th:text="${inmueble.numBanos}">2</span></p>
                        <p><strong>m²:</strong> <span th:text="${inmueble.metrosCuadrados}">100</span></p>
                        <p><strong>Comunidad:</strong> <span th:text="${inmueble.comunidad}">Andalucía</span></p>
                        <p><strong>Cert. Energía:</strong> <span th:text="${inmueble.certificadoEnergia}">B</span></p>
                        <p><strong>IBI:</strong> <span th:text="${inmueble.ibi}">€/año</span></p>
                    </div>
                </div>
                <div class="row" th:if="${inmueble.anotaciones}">
                    <div class="col-12">
                        <p><strong>Anotaciones:</strong></p>
                        <p class="text-muted" th:text="${inmueble.anotaciones}">Sin anotaciones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- VENDEDORES DEL INMUEBLE -->
        <!-- ========================================================================= -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge"></i> Vendedores del Inmueble
                    <span class="badge bg-light text-dark" th:text="${vendedores.size()}">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" th:if="${!vendedores.isEmpty()}">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>NIF</th>
                                <th>Contacto</th>
                                <th>Representante</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="vi : ${vendedores}">
                                <td th:text="${vi.vendedor.nombreCompleto}">Juan Pérez García</td>
                                <td th:text="${vi.vendedor.nif}">12345678A</td>
                                <td th:text="${vi.vendedor.contacto}">666777888</td>
                                <td>
                                    <span class="badge bg-info" th:text="${vi.representante}">Notaría García</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div th:if="${vendedores.isEmpty()}" class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay vendedores asignados a este inmueble
                </div>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- CITAS PROGRAMADAS -->
        <!-- ========================================================================= -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-check"></i> Citas Programadas
                    <span class="badge bg-light text-dark" th:text="${citas.size()}">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" th:if="${!citas.isEmpty()}">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Interesado</th>
                                <th>Contacto</th>
                                <th>Trabajador</th>
                                <th>Anotaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="cita : ${citas}">
                                <td>
                                    <i class="bi bi-calendar3"></i>
                                    <span th:text="${#temporals.format(cita.fecha, 'dd/MM/yyyy')}">01/01/2024</span>
                                </td>
                                <td>
                                    <i class="bi bi-clock"></i>
                                    <span th:text="${#temporals.format(cita.hora, 'HH:mm')}">10:00</span>
                                </td>
                                <td th:text="${cita.interesado.nombreCompleto}">María López Ruiz</td>
                                <td th:text="${cita.interesado.contacto}">666888999</td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${cita.trabajador.nombreCompleto}">Carlos
                                        Ruiz</span>
                                </td>
                                <td>
                                    <small class="text-muted" th:text="${cita.anotaciones ?: '-'}">Primera
                                        visita</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div th:if="${citas.isEmpty()}" class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay citas programadas para este inmueble
                </div>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- INTERESADOS (FAVORITOS) -->
        <!-- ========================================================================= -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-heart-fill"></i> Interesados (Favoritos)
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center" style="min-height: 80px;">
                    <div>
                        <h2 class="display-4 mb-2" th:text="${cantidadInteresados}">0</h2>
                        <p class="lead mb-0">
                            <span th:if="${cantidadInteresados == 0}">
                                Nadie ha guardado este inmueble como favorito aún
                            </span>
                            <span th:if="${cantidadInteresados == 1}">
                                usuario ha guardado este inmueble en favoritos
                            </span>
                            <span th:if="${cantidadInteresados > 1}">
                                usuarios han guardado este inmueble en favoritos
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- PROPIEDADES ADICIONALES (⭐ SECCIÓN MODIFICADA) -->
        <!-- ========================================================================= -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-boxes"></i> Propiedades Adicionales
                    <!-- ✅ CORRECTO: Usa la variable separada -->
                    <span class="badge bg-light text-dark" th:text="${propiedadesAdicionales.size()}">0</span>
                </h5>
                <a th:href="@{/propiedades/new/inmueble/{id}(id=${inmueble.id})}" class="btn btn-light btn-sm">
                    <i class="bi bi-plus-circle"></i> Añadir
                </a>
            </div>
            <div class="card-body">
                <!-- ✅ CORRECTO: Usa la variable separada -->
                <div class="table-responsive" th:if="${!propiedadesAdicionales.isEmpty()}">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Tipo</th>
                                <th>Derrama</th>
                                <th>IBI</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- ✅ CORRECTO: Usa la variable separada -->
                            <tr th:each="propiedad : ${propiedadesAdicionales}">
                                <td th:text="${propiedad.id}">1</td>
                                <td th:text="${propiedad.tipo}">Garaje</td>
                                <td
                                    th:text="${#numbers.formatDecimal(propiedad.derrama, 1, 'POINT', 2, 'COMMA')} + ' €'">
                                    50,00 €</td>
                                <td th:text="${propiedad.ibi}">100 €/año</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/propiedades/{id}(id=${propiedad.id})}" class="btn btn-info">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a th:href="@{/propiedades/{id}/edit(id=${propiedad.id})}"
                                            class="btn btn-warning">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form th:action="@{/propiedades/{id}/delete(id=${propiedad.id})}" method="post"
                                            style="display:inline;"
                                            onsubmit="return confirmarEliminacion('¿Eliminar?');">
                                            <button type="submit" class="btn btn-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ✅ CORRECTO: Usa la variable separada -->
                <div th:if="${propiedadesAdicionales.isEmpty()}" class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay propiedades adicionales.
                    <a th:href="@{/propiedades/new/inmueble/{id}(id=${inmueble.id})}">Añadir la primera</a>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{layout/base :: scripts}"></div>
</body>

</html>